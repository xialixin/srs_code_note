<html>

<head>
<meta http-equiv=Content-Type content="text/html; charset=gb2312">
<meta name=Generator content="Microsoft Word 15 (filtered)">
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:宋体;
	panose-1:2 1 6 0 3 1 1 1 1 1;}
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:等线;
	panose-1:2 1 6 0 3 1 1 1 1 1;}
@font-face
	{font-family:"等线 Light";
	panose-1:2 1 6 0 3 1 1 1 1 1;}
@font-face
	{font-family:"\@等线";
	panose-1:2 1 6 0 3 1 1 1 1 1;}
@font-face
	{font-family:"\@等线 Light";
	panose-1:2 1 6 0 3 1 1 1 1 1;}
@font-face
	{font-family:"\@宋体";
	panose-1:2 1 6 0 3 1 1 1 1 1;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:等线;}
h1
	{mso-style-link:"标题 1 字符";
	margin-top:17.0pt;
	margin-right:0cm;
	margin-bottom:16.5pt;
	margin-left:0cm;
	text-align:justify;
	text-justify:inter-ideograph;
	line-height:240%;
	page-break-after:avoid;
	font-size:22.0pt;
	font-family:等线;
	font-weight:bold;}
h2
	{mso-style-link:"标题 2 字符";
	margin-top:13.0pt;
	margin-right:0cm;
	margin-bottom:13.0pt;
	margin-left:0cm;
	text-align:justify;
	text-justify:inter-ideograph;
	line-height:173%;
	page-break-after:avoid;
	font-size:16.0pt;
	font-family:"等线 Light";
	font-weight:bold;}
h3
	{mso-style-link:"标题 3 字符";
	margin-top:13.0pt;
	margin-right:0cm;
	margin-bottom:13.0pt;
	margin-left:0cm;
	text-align:justify;
	text-justify:inter-ideograph;
	line-height:173%;
	page-break-after:avoid;
	font-size:16.0pt;
	font-family:等线;
	font-weight:bold;}
h4
	{mso-style-link:"标题 4 字符";
	margin-top:14.0pt;
	margin-right:0cm;
	margin-bottom:14.5pt;
	margin-left:0cm;
	text-align:justify;
	text-justify:inter-ideograph;
	line-height:156%;
	page-break-after:avoid;
	font-size:14.0pt;
	font-family:"等线 Light";
	font-weight:bold;}
p.MsoToc1, li.MsoToc1, div.MsoToc1
	{margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:等线;}
p.MsoToc2, li.MsoToc2, div.MsoToc2
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:21.0pt;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:等线;}
p.MsoToc3, li.MsoToc3, div.MsoToc3
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:42.0pt;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:等线;}
p.MsoHeader, li.MsoHeader, div.MsoHeader
	{mso-style-link:"页眉 字符";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	layout-grid-mode:char;
	border:none;
	padding:0cm;
	font-size:9.0pt;
	font-family:等线;}
p.MsoFooter, li.MsoFooter, div.MsoFooter
	{mso-style-link:"页脚 字符";
	margin:0cm;
	margin-bottom:.0001pt;
	layout-grid-mode:char;
	font-size:9.0pt;
	font-family:等线;}
a:link, span.MsoHyperlink
	{color:blue;
	text-decoration:underline;}
a:visited, span.MsoHyperlinkFollowed
	{color:#954F72;
	text-decoration:underline;}
p
	{margin-right:0cm;
	margin-left:0cm;
	font-size:12.0pt;
	font-family:宋体;}
p.MsoNoSpacing, li.MsoNoSpacing, div.MsoNoSpacing
	{margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:等线;}
p.MsoListParagraph, li.MsoListParagraph, div.MsoListParagraph
	{margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:21.0pt;
	font-size:10.5pt;
	font-family:等线;}
p.MsoTocHeading, li.MsoTocHeading, div.MsoTocHeading
	{margin-top:12.0pt;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:0cm;
	margin-bottom:.0001pt;
	line-height:107%;
	page-break-after:avoid;
	font-size:16.0pt;
	font-family:"等线 Light";
	color:#2F5496;}
span.1
	{mso-style-name:"标题 1 字符";
	mso-style-link:"标题 1";
	font-weight:bold;}
span.2
	{mso-style-name:"标题 2 字符";
	mso-style-link:"标题 2";
	font-family:"等线 Light";
	font-weight:bold;}
span.3
	{mso-style-name:"标题 3 字符";
	mso-style-link:"标题 3";
	font-weight:bold;}
span.4
	{mso-style-name:"标题 4 字符";
	mso-style-link:"标题 4";
	font-family:"等线 Light";
	font-weight:bold;}
span.a
	{mso-style-name:"页眉 字符";
	mso-style-link:页眉;}
span.a0
	{mso-style-name:"页脚 字符";
	mso-style-link:页脚;}
.MsoChpDefault
	{font-family:等线;}
 /* Page Definitions */
 @page WordSection1
	{size:595.3pt 841.9pt;
	margin:72.0pt 90.0pt 72.0pt 90.0pt;
	layout-grid:15.6pt;}
div.WordSection1
	{page:WordSection1;}
 /* List Definitions */
 ol
	{margin-bottom:0cm;}
ul
	{margin-bottom:0cm;}
-->
</style>

</head>

<body lang=ZH-CN link=blue vlink="#954F72" style='text-justify-trim:punctuation'>

<div class=WordSection1 style='layout-grid:15.6pt'>

<h1><a name="_Toc37241872">微信小程序网关设计方案</a></h1>

<p class=MsoTocHeading>目录</p>

<p class=MsoToc1><span lang=EN-US><span class=MsoHyperlink><a
href="#_Toc37241872"><span lang=EN-US><span lang=EN-US>微信小程序网关设计方案</span></span><span
style='color:windowtext;display:none;text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>1</span></a></span></span></p>

<p class=MsoToc1><span class=MsoHyperlink><span lang=EN-US><a
href="#_Toc37241873"><span lang=EN-US><span lang=EN-US>需求</span></span><span
style='color:windowtext;display:none;text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>1</span></a></span></span></p>

<p class=MsoToc1><span class=MsoHyperlink><span lang=EN-US><a
href="#_Toc37241874"><span lang=EN-US><span lang=EN-US>应用场景</span></span><span
style='color:windowtext;display:none;text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>1</span></a></span></span></p>

<p class=MsoToc2><span class=MsoHyperlink><span lang=EN-US><a
href="#_Toc37241875"><span lang=EN-US><span lang=EN-US>小程序仅加入会议</span></span><span
style='color:windowtext;display:none;text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>1</span></a></span></span></p>

<p class=MsoToc2><span class=MsoHyperlink><span lang=EN-US><a
href="#_Toc37241876"><span lang=EN-US><span lang=EN-US>小程序与一个APP</span></span><span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>1</span></a></span></span></p>

<p class=MsoToc2><span class=MsoHyperlink><span lang=EN-US><a
href="#_Toc37241877"><span lang=EN-US><span lang=EN-US>小程序与多个APP</span></span><span
style='color:windowtext;display:none;text-decoration:none'>. </span><span
style='color:windowtext;display:none;text-decoration:none'>1</span></a></span></span></p>

<p class=MsoToc2><span class=MsoHyperlink><span lang=EN-US><a
href="#_Toc37241878"><span lang=EN-US><span lang=EN-US>两个小程序</span></span><span
style='color:windowtext;display:none;text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>1</span></a></span></span></p>

<p class=MsoToc2><span class=MsoHyperlink><span lang=EN-US><a
href="#_Toc37241879"><span lang=EN-US><span lang=EN-US>多个app</span></span><span
lang=EN-US><span lang=EN-US>与多个小程序</span></span><span style='color:windowtext;
display:none;text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>1</span></a></span></span></p>

<p class=MsoToc1><span class=MsoHyperlink><span lang=EN-US><a
href="#_Toc37241880"><span lang=EN-US><span lang=EN-US>模块</span></span><span
style='color:windowtext;display:none;text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>1</span></a></span></span></p>

<p class=MsoToc2><span class=MsoHyperlink><span lang=EN-US><a
href="#_Toc37241881"><span lang=EN-US><span lang=EN-US>微信网关结构图</span></span><span
style='color:windowtext;display:none;text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>1</span></a></span></span></p>

<p class=MsoToc2><span class=MsoHyperlink><span lang=EN-US><a
href="#_Toc37241882"><span lang=EN-US><span lang=EN-US>交互流程</span></span><span
style='color:windowtext;display:none;text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>1</span></a></span></span></p>

<p class=MsoToc3><span class=MsoHyperlink><span lang=EN-US><a
href="#_Toc37241883"><span lang=EN-US><span lang=EN-US>小程序加入会议流程</span></span><span
style='color:windowtext;display:none;text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>1</span></a></span></span></p>

<p class=MsoToc3><span class=MsoHyperlink><span lang=EN-US><a
href="#_Toc37241884"><span lang=EN-US><span lang=EN-US>多个小程序请求同一app</span></span><span
lang=EN-US><span lang=EN-US>视频不包括声音流程</span></span><span style='color:windowtext;
display:none;text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>1</span></a></span></span></p>

<p class=MsoToc3><span class=MsoHyperlink><span lang=EN-US><a
href="#_Toc37241885"><span lang=EN-US><span lang=EN-US>小程序请求视频流程</span></span><span
style='color:windowtext;display:none;text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>1</span></a></span></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h1><a name="_Toc37241873">需求</a></h1>

<p class=MsoListParagraph style='margin-left:18.0pt;text-indent:0cm'><span
lang=EN-US>1.</span>小程序加入会议，其他客户端能看到小程序会议的视频与声音</p>

<p class=MsoListParagraph style='margin-left:18.0pt;text-indent:0cm'><span
lang=EN-US>2.</span>小程序需要其他客户端视频与声音</p>

<p class=MsoListParagraph style='margin-left:18.0pt;text-indent:0cm'><span
lang=EN-US>3.</span>其他客户端能看到小程序会议音视频</p>

<p class=MsoListParagraph style='margin-left:18.0pt;text-indent:0cm'><span
lang=EN-US>4.</span>可以多个小程序加入会议</p>

<p class=MsoListParagraph style='margin-left:18.0pt;text-indent:0cm'><span
lang=EN-US>5.</span>小程序可以获取其他小程序的会议音视频</p>

<p class=MsoListParagraph style='margin-left:18.0pt;text-indent:0cm'><span
lang=EN-US>&nbsp;</span></p>

<h1><a name="_Toc37241874">应用场景</a></h1>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp; </span>小程序加入会议有多种场景</p>

<h2><a name="_Toc37241875">小程序仅加入会议</a></h2>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp; <img width=827 height=185
src="wx_conf_gateway.files/image001.png"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; </span>这种场景应用是小程序加入会议后，只需要会议声音，不需要看其他的视频</p>

<p class=MsoListParagraph style='margin-left:18.0pt;text-indent:0cm'><span
lang=EN-US>&nbsp;</span></p>

<h2><a name="_Toc37241876">小程序与一个<span lang=EN-US>APP</span></a></h2>

<p class=MsoListParagraph style='margin-left:18.0pt;text-indent:0cm'><span
lang=EN-US><img width=818 height=386 src="wx_conf_gateway.files/image002.png"></span></p>

<p class=MsoListParagraph style='margin-left:18.0pt;text-indent:0cm'>小程序与<span
lang=EN-US>app</span>加入会议后，小程序需要看到<span lang=EN-US>app</span>的视频，同时与需要会议的声音， <span
lang=EN-US>app</span>也需要看到小程序的视频，同时听到会议的声音</p>

<p class=MsoListParagraph style='margin-left:18.0pt;text-indent:0cm'><span
lang=EN-US>&nbsp;</span></p>

<h2><a name="_Toc37241877">小程序与多个<span lang=EN-US>APP</span></a></h2>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US><img width=848 height=435
src="wx_conf_gateway.files/image003.png"></span></p>

<p class=MsoNormal>小程序与多个<span lang=EN-US>app</span>加入会议， 每个<span lang=EN-US>app</span>需要会议声音与其他<span
lang=EN-US>app</span>与小程序的视频，小程序需要会议声音与所有<span lang=EN-US>app</span>的视频<span
lang=EN-US><br>
<br>
</span></p>

<h2><a name="_Toc37241878">两个小程序</a></h2>

<p class=MsoNormal><span lang=EN-US><img width=854 height=431
src="wx_conf_gateway.files/image004.png"></span></p>

<p class=MsoNormal>两个小程序加入会议后，小程序<span lang=EN-US>1</span>需要会议声音与小程序<span
lang=EN-US>2</span>的视频， 小程序<span lang=EN-US>2</span>需要会议声音与小程序<span lang=EN-US>1</span>的视频</p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h2><a name="_Toc37241879">多个<span lang=EN-US>app</span>与多个小程序</a></h2>

<p class=MsoNormal><span lang=EN-US><img width=862 height=427
src="wx_conf_gateway.files/image005.png"></span></p>

<p class=MsoNormal>多个小程序与多个<span lang=EN-US>app</span>加入会议后， 每个<span
lang=EN-US>app</span>或小程序需要看到其他所视频以及会议的声音</p>

<h1><a name="_Toc37241880">模块</a></h1>

<h2><a name="_Toc37241881">微信网关结构图</a></h2>

<p class=MsoListParagraph style='margin-left:18.0pt;text-indent:0cm'><span
lang=EN-US><img width=806 height=583 src="wx_conf_gateway.files/image006.png"></span></p>

<p class=MsoListParagraph style='margin-left:18.0pt'><b>微信网关程序</b>主要功能将小程序推到直播服务器的音视频流，拉过来之后，将音视频解复用，再将音频与视频分别推送给会议系统的<span
lang=EN-US>mas, </span>这样小程序就加入会议开会。同时微信网关与会将会议中其他<span lang=EN-US>app</span>的音视频拉过来之后，再将复合成<span
lang=EN-US>rtmp</span>流推到直播服务器，然后小程序将可以拉到其他<span lang=EN-US>app</span>的音视频</p>

<p class=MsoListParagraph style='margin-left:18.0pt'>每个小程序加入同一会议后，将这个会议的声音返回给小程序，这路声音是从会议<span
lang=EN-US>mas</span>中传送过来，<span lang=EN-US>rtpRecver</span>收到之后将放入该小程序的<span
lang=EN-US>audio Pub</span>与<span lang=EN-US>video pub</span>中，如果小程序只需要声音，<span
lang=EN-US>flv muxer</span>订阅该通道的<span lang=EN-US>audio, </span>转发到直播服务器，小程序再从直播服务器拉流。如果同时小程序需要其他<span
lang=EN-US>app</span>视频，需要通过<span lang=EN-US>mas</span>将<span lang=EN-US>app</span>视频传送过来，<span
lang=EN-US>flv muxer</span>将音频与视频复后成一路<span lang=EN-US>rtmp</span>推送到直播服务器。</p>

<p class=MsoListParagraph style='margin-left:18.0pt'>小程序请求视频有两种情况，一种时请求<span
lang=EN-US>app</span>的视频需要通过<span lang=EN-US>mas</span>传送过来，另外一种时同会议中其他小程序的视频，因为其他小程序视频是通过微信网关拉过来，再转发到<span
lang=EN-US>mas, </span>所以其他小程序的视频，在转发<span lang=EN-US>mas </span>需要放到<span
lang=EN-US>video pub, </span>如果有其他小程序需要该视频，直接订阅之后，再通过<span lang=EN-US>flv muxer</span>复后之后发送到直播服务器</p>

<p class=MsoListParagraph style='margin-left:18.0pt'><span style='color:red'>同一会议的所有小程序音视频处理，需要确保在同一个微信网关程序处理，集群环境也需要这样</span></p>

<h2><a name="_Toc37241882">交互流程</a></h2>

<h3><a name="_Toc37241883">小程序加入会议流程</a></h3>

<p class=MsoListParagraph style='margin-left:18.0pt;text-indent:0cm'><span
lang=EN-US><img width=824 height=739 src="wx_conf_gateway.files/image007.png"></span></p>

<h3><a name="_Toc37241884">多个小程序请求同一<span lang=EN-US>app</span>视频不包括声音流程</a></h3>

<p class=MsoListParagraph style='margin-left:18.0pt;text-indent:0cm'><span
lang=EN-US><img width=796 height=750 src="wx_conf_gateway.files/image008.png"></span></p>

<h3><a name="_Toc37241885">小程序请求视频流程</a></h3>

<p class=MsoNormal><span lang=EN-US><img width=830 height=746
src="wx_conf_gateway.files/image009.png"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h4>请求普通成员视频<span lang=EN-US>: </span></h4>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1</span>只需要视频：<span
lang=EN-US>&nbsp; </span>如果成员已经在<span lang=EN-US>wxgw, </span>直接到直播服务器拉流，否则将该成员的会议视频从<span
lang=EN-US>mas</span>推流到<span lang=EN-US>wxgw. </span>同时推流到直播服务器，再从直播服务拉流</p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2.</span>需要视频同时需要混音<span
lang=EN-US>, </span>首先走只需要视频流程，同时将该成员视频与小程序成员的混音合同一路直播流，推流直播服务器，再拉流</p>

<h4>请求小程序成员视频<span lang=EN-US>:&nbsp; </span></h4>

<p class=MsoListParagraph style='margin-left:49.5pt;text-indent:-18.0pt'><span
lang=EN-US>1．<span style='font:7.0pt "Times New Roman"'> </span></span>只要视频，</p>

<p class=MsoNormal style='margin-left:31.5pt;text-indent:21.0pt'>方案<span
lang=EN-US>1:</span>在<span lang=EN-US>wxgw</span>检查有没有该小程序<span lang=EN-US>rtmp2rtp,
</span>如果没有创建一个，然后解复合<span lang=EN-US>video, audio, </span>然后将<span lang=EN-US>video</span>到推直播服务器，
</p>

<p class=MsoNormal style='margin-left:31.5pt;text-indent:21.0pt'>方案<span
lang=EN-US>2:</span>直在从直播服务器拉小程序参与的<span lang=EN-US>rtmp</span>流，包括有<span
lang=EN-US>AV, </span>小程序播放时，把<span lang=EN-US>A</span>禁用</p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2.</span>需要混音</p>

<p class=MsoNormal style='text-indent:42.0pt'><span lang=EN-US>wxgw</span>拉流后解复合<span
lang=EN-US>video, audio, </span>再将<span lang=EN-US>video</span>与小程序混音复合成<span
lang=EN-US>rtmp</span>流</p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

</div>

</body>

</html>
